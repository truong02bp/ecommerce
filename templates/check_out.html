{% extends 'main.html' %}
{% block content %}
    {% include 'common/check_out_style.html' %}
    <div class="row">
        <div class="col-md-2">
        </div>
        <div class="col-md-8">
            <div style="margin-top: 30px; margin-bottom: 50px">
                <div class="wrapper wrapper_1"
                     style="display: flex;  width: 100%; align-items: center; position: relative">
                    <div class="title" style="width: 225px;">
                        Information delivery
                    </div>
                    <div class="select_wrap select_wrap_1" style="margin-left: 30px;         width: 600px;">

                        <ul class="default_option default_option_1">
                            <li>
                                <div class="option pizza">
                                    <div class="icon"></div>
                                    {% if information_list %}
                                        <p>{{ information_list.first }}</p>
                                    {% endif %}
                                </div>
                            </li>
                        </ul>
                        <ul class="select_ul select_1">
                            {% for information in information_list %}
                                <li>
                                    <div class="option burger">
                                        <div class="icon"></div>
                                        <p>{{ information }}</p>
                                    </div>
                                </li>
                            {% endfor %}

                        </ul>
                    </div>
                </div>
            </div>
            <h3>Items </h3>
            {% for cart_item in cart_items %}
                <div class="row row-cart" style="margin-bottom: 15px;" data-value="{{ cart_item.id }}">
                    <div class="col-md-2">
                        <img src="http://localhost:8000/image/download/{{ cart_item.item.image }}"
                             alt="product"
                             class="img-responsive img-product">
                    </div>
                    <div class="col-md-2" style="text-align: center;padding-top: 58px;">
                        {{ cart_item.item.name }}
                    </div>
                    <div class="col-md-2 price-format" style="text-align: right;padding-top: 58px;">
                        {{ cart_item.item.price }}
                    </div>
                    <div class="col-md-3" style="text-align: right;padding-top: 42px;">
                        <div class="cart-product-two shopping-cart-quantity cartConver">
                            <div class="pd-c-quantity quantity add-card add-card-product">
                                <input class="quantity-item" type="number" min="1" max="100" step="1"
                                       value="{{ cart_item.quantity }}"
                                       style="border-bottom: 1px solid rgb(193, 155, 118);padding-bottom: 10px;"
                                       disabled>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 cart-price price-format"
                         data-price="{{ cart_item.total_price }}"
                         id="{{ cart_item.id }}"
                         style="text-align: right;padding-top: 58px;">{{ cart_item.total_price }}
                    </div>
                </div>
            {% endfor %}
            <div class="cartCoupon">
                <ul>
                    <li style="font-size: 16px;font-weight: bold;">Coupon code</li>
                    <li style="margin-left: 20px;margin-right: 20px;">
                        <div class="accInput">
                            <input type="text" class="inputText input-code" placeholder="Code"
                                   style="background: transparent;width: 260px;font-size: 16px;">
                        </div>
                    </li>
                    <li>
                        <a href="#" class="btn-formTax2">
                            <div>Apply</div>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="box-formTax-total">
                <div class="row">
                    <div class="col-md-6" style="font-size: 18px;font-weight: bold">Total price</div>
                    <div class="col-md-5 last-price" id="last-price"
                         style="text-align: right;font-size: 18px;font-weight: bold">
                        $670.00
                    </div>
                    <div class="col-md-1" style="font-size: 18px;font-weight: bold"></div>
                </div>
            </div>
            <div style="margin-top: 50px;">
                <div class="wrapper" style="display: flex;  width: 100%; align-items: center; position: relative">
                    <div class="title" style="width: 225px;">
                        Shipment
                    </div>
                    <div class="select_wrap select_wrap_2" style="margin-left: 0px;         width: 300px;">

                        <ul class="default_option default_option_2">
                            <li>

                                <div class="option pizza">
                                    <div class="icon"></div>
                                    {% if shipment_unit_list %}
                                        <p>{{ shipment_unit_list.first.name }}</p>
                                    {% endif %}
                                </div>

                            </li>

                        </ul>
                        <ul class="select_ul select_2">
                            {% for shipment_unit in shipment_unit_list %}
                                <li>
                                    <div class="option burger">
                                        <div class="icon"></div>
                                        <p>{{ shipment_unit.name }}</p>
                                    </div>
                                </li>
                            {% endfor %}

                        </ul>
                    </div>
                    <div class="title" style="width: 225px;">
                        Payment
                    </div>
                    <div class="select_wrap select_wrap_3" style="margin-left: 0px;         width: 300px;">

                        <ul class="default_option default_option_3">
                            <li>
                                <div class="option pizza">
                                    <div class="icon"></div>
                                    <p>Thanh toán khi nhận hàng</p>
                                </div>
                            </li>
                        </ul>
                        <ul class="select_ul select_3">
                            <li>
                                <div class="option burger">
                                    <div class="icon"></div>
                                    <p>Thanh toán khi nhận hàng</p>
                                </div>
                            </li>
                            {% for bank_info in bank_info_list %}
                                <li>
                                    <div class="option burger">
                                        <div class="icon"></div>
                                        <p>{{ bank_info.name }}</p>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="row" style="display: flex">
                <div class="btn-order btn-formTax"
                     style="height: 40px; width: 100px; margin-bottom: 100px; margin-right: 30px">
                    <div>Order</div>
                </div>
                <a href="{% url 'cart' %}">
                    <div class="btn-formTax" style="height: 40px; width: 100px; margin-bottom: 100px;">
                        <div>Cancel</div>
                    </div>
                </a>

            </div>

        </div>
        <div class="col-md-2">
        </div>
    </div>
    <script>
        $(".default_option_1").click(function () {
            $(this).parent().toggleClass("active");
        })

        $(".select_1 li").click(function () {
            var currentele = $(this).html();
            $(".default_option_1 li").html(currentele);
            $(this).parents(".select_wrap_1").removeClass("active");
        })

        $(".default_option_2").click(function () {
            $(this).parent().toggleClass("active");
        })

        $(".select_2 li").click(function () {
            var currentele = $(this).html();
            $(".default_option_2 li").html(currentele);
            $(this).parents(".select_wrap_2").removeClass("active");
        })

        $(".default_option_3").click(function () {
            $(this).parent().toggleClass("active");
        })

        $(".select_3 li").click(function () {
            var currentele = $(this).html();
            $(".default_option_3 li").html(currentele);
            $(this).parents(".select_wrap_3").removeClass("active");
        })

        $(".btn-order").click(function () {
            let address = $(".default_option_1 li p").html();
            let shipment = $(".default_option_2 li p").html();
            let payment = $(".default_option_3 li p").html();
            let total_price = toNumber($('#last-price').html());
            let ids = []
            $('.cart-price').each(function () {
                ids.push(this.id)
            });
            $.ajax(
                {
                    url: '/api/order/add',
                    type: 'POST',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    data:
                        {
                            ids: ids.toString(),
                            address_info: address,
                            shipment_info: shipment,
                            payment_info: payment,
                            total_price: total_price
                        },
                    success: function (value) {
                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Order success',
                            showConfirmButton: true,
                            timer: 2000
                        })
                    },
                    error: function () {
                        Swal.fire(
                            {
                                icon: 'error',
                                title: 'Oops...'
                            }
                        )
                    }
                }
            )
        })

        function toNumber(priceString) {
            let price = 0;
            let end;
            for (let i = 0; i < priceString.length; i++) {
                if (priceString[i] >= '0' && priceString[i] <= '9') {
                    price = price * 10 + (priceString[i] - '0');
                    end = i;
                }
            }
            if (priceString[end] === '0' && priceString[end - 1] === '.')
                price /= 10;
            return price;
        }

        function toString(totalPrice) {
            let rs = "₫";
            let total = totalPrice.toString();
            let cnt = 0;
            for (let i = total.length - 1; i >= 0; i--) {
                rs += total[i];
                cnt++;
                if (cnt === 3 && i !== 0) {
                    rs += ",";
                    cnt = 0;
                }
            }
            rs = rs.split("").reverse().join("");
            return rs;
        }

        function totalPrice() {
            let totalPrice = 0;
            $('.cart-price').each(function () {
                let priceString = $(this).text();
                totalPrice += toNumber(priceString);
            })
            let lastTotalPrice = totalPrice;
            console.log(lastTotalPrice)
            $('#last-price').html(toString(lastTotalPrice));
        }

        totalPrice()
    </script>
{% endblock %}